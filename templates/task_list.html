{% extends "base.html" %}

{% block title %}任务列表 - 诺禾云数据下载管理器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-list-task"></i>
        下载任务列表
    </h2>
    <div>
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i>
            新建任务
        </a>
        <button class="btn btn-outline-secondary" onclick="refreshTasks()">
            <i class="bi bi-arrow-clockwise"></i>
            刷新
        </button>
    </div>
</div>

{% if tasks %}
    <div class="row">
        {% for task_id, task in tasks.items() %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-file-earmark-arrow-down"></i>
                        {{ task.info.username }}
                    </h6>
                    <span class="badge bg-{{ task.status.value | status_badge }}">
                        {{ task.status.value | title }}
                    </span>
                </div>
                
                <div class="card-body">
                    <!-- 基本信息 -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">任务ID</small>
                            <div class="fw-bold small">{{ task_id }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">数据大小</small>
                            <div class="fw-bold small">{{ task.info.total_size or '未知' }}</div>
                        </div>
                    </div>

                    <!-- 进度条 -->
                    {% if task.status.value in ['downloading', 'validating', 'logging_in', 'listing'] %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small">
                            <span>{{ task.current_step or '处理中...' }}</span>
                            <span>{{ "%.1f" | format(task.progress) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: {{ task.progress }}%"></div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- 时间信息 -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">开始时间</small>
                            <div class="small">{{ task.start_time | datetime }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">{% if task.end_time %}完成时间{% else %}状态{% endif %}</small>
                            <div class="small">
                                {% if task.end_time %}
                                    {{ task.end_time | datetime }}
                                {% else %}
                                    {{ task.current_step or '等待中' }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- 样品信息 -->
                    {% if task.info.sample_names %}
                    <div class="mb-3">
                        <small class="text-muted">样品信息</small>
                        <div class="small">
                            {{ task.info.sample_count or '未知' }} 个样品
                            {% if task.info.sample_names %}
                            <br>
                            <span class="text-muted">{{ task.info.sample_names[:50] }}{% if task.info.sample_names|length > 50 %}...{% endif %}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 错误信息 -->
                    {% if task.error_message %}
                    <div class="alert alert-danger alert-sm py-2 mb-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <small>{{ task.error_message }}</small>
                    </div>
                    {% endif %}
                </div>

                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100" role="group">
                        <a href="{{ url_for('task_status', task_id=task_id) }}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i>
                            详情
                        </a>
                        
                        {% if task.status.value == 'completed' %}
                        <a href="{{ url_for('validate_files', task_id=task_id) }}" 
                           class="btn btn-outline-success btn-sm">
                            <i class="bi bi-check-circle"></i>
                            验证
                        </a>
                        {% endif %}

                        {% if task.status.value in ['pending', 'logging_in', 'listing', 'downloading', 'validating'] %}
                        <button class="btn btn-outline-warning btn-sm" 
                                onclick="cancelTask('{{ task_id }}')">
                            <i class="bi bi-stop-circle"></i>
                            取消
                        </button>
                        {% endif %}

                        {% if task.status.value in ['completed', 'failed', 'cancelled'] %}
                        <button class="btn btn-outline-danger btn-sm" 
                                onclick="removeTask('{{ task_id }}')">
                            <i class="bi bi-trash"></i>
                            删除
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 统计信息 -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        {% set completed_count = tasks.values() | selectattr('status.value', 'eq', 'completed') | list | length %}
                        {{ completed_count }}
                    </h5>
                    <p class="card-text small">已完成</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h5 class="card-title text-info">
                        {% set running_count = tasks.values() | selectattr('status.value', 'in', ['downloading', 'logging_in', 'listing', 'validating']) | list | length %}
                        {{ running_count }}
                    </h5>
                    <p class="card-text small">进行中</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        {% set pending_count = tasks.values() | selectattr('status.value', 'eq', 'pending') | list | length %}
                        {{ pending_count }}
                    </h5>
                    <p class="card-text small">等待中</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">
                        {% set failed_count = tasks.values() | selectattr('status.value', 'eq', 'failed') | list | length %}
                        {{ failed_count }}
                    </h5>
                    <p class="card-text small">失败</p>
                </div>
            </div>
        </div>
    </div>

{% else %}
    <!-- 空状态 -->
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="bi bi-inbox display-1 text-muted"></i>
        </div>
        <h4 class="text-muted">暂无下载任务</h4>
        <p class="text-muted">点击下面的按钮创建第一个下载任务</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i>
            创建任务
        </a>
    </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// 自动刷新任务状态
let autoRefreshEnabled = true;
let refreshInterval;

function startAutoRefresh() {
    if (autoRefreshEnabled) {
        refreshInterval = setInterval(refreshTasksQuiet, 5000); // 每5秒刷新一次
    }
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

function refreshTasks() {
    location.reload();
}

function refreshTasksQuiet() {
    // 静默刷新，只更新进行中的任务
    const runningTasks = document.querySelectorAll('.progress');
    const runningStatuses = ['downloading', 'logging_in', 'listing', 'validating', 'pending'];
    
    // 检查是否有进行中的任务
    const hasRunningTasks = Array.from(document.querySelectorAll('.badge')).some(badge => {
        const status = badge.textContent.toLowerCase().trim();
        return runningStatuses.includes(status);
    });
    
    if (hasRunningTasks || runningTasks.length > 0) {
        // 如果有进行中的任务，才进行刷新
        fetch(location.href)
            .then(response => response.text())
            .then(html => {
                // 简单的页面替换，实际项目中建议使用更精细的更新
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.querySelector('main').innerHTML;
                document.querySelector('main').innerHTML = newContent;
            })
            .catch(console.error);
    } else {
        // 如果没有进行中的任务，停止自动刷新
        console.log('没有进行中的任务，停止自动刷新');
        stopAutoRefresh();
    }
}

function cancelTask(taskId) {
    if (confirm('确定要取消这个下载任务吗？')) {
        fetch(`/api/task/${taskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('任务已取消');
                refreshTasks();
            } else {
                alert('取消失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('操作失败');
        });
    }
}

function removeTask(taskId) {
    if (confirm('确定要删除这个任务吗？删除后无法恢复。')) {
        fetch(`/api/task/${taskId}/remove`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('任务已删除');
                refreshTasks();
            } else {
                alert('删除失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('操作失败');
        });
    }
}

// 页面加载时启动自动刷新
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// 页面卸载时停止自动刷新
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// 页面可见性变化时控制自动刷新
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
{% endblock %}
